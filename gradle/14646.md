$$config
title: ì„ì‹œê¸€
listed: false
published: true
$$

# ê´€ë ¨ë§í¬
- [ë¦¬í¬ì§€í„°ë¦¬ - https://github.com/farrar142-examples/p-14646-1](https://github.com/farrar142-examples/p-14646-1)

---

## ğŸ“Œ JPA vs Spring Data Elasticsearch í•µì‹¬ ì°¨ì´ì 

> JPAì— ìµìˆ™í•œ ê°œë°œìë¥¼ ìœ„í•œ Spring Data Elasticsearch í•µì‹¬ ë¹„êµí‘œ

| ê°œë… | JPA (RDB) | Spring Data Elasticsearch |
|------|-----------|---------------------------|
| **ì–´ë…¸í…Œì´ì…˜** | `@Entity` | `@Document` |
| **ID íƒ€ì…** | Long, UUID ë“± | ë³´í†µ `String` (Elasticsearch ê¸°ë³¸) |
| **í…Œì´ë¸”/ì¸ë±ìŠ¤** | `@Table(name="...")` | `@Document(indexName="...")` |
| **ì»¬ëŸ¼ ë§¤í•‘** | `@Column` | `@Field(type=FieldType.xxx)` |
| **Repository** | `JpaRepository<T, ID>` | `ElasticsearchRepository<T, ID>` |
| **ê´€ê³„ ë§¤í•‘** | `@OneToMany`, `@ManyToOne` ë“± | âŒ ì—†ìŒ (ë¹„ì •ê·œí™”/ID ì°¸ì¡°) |
| **íŠ¸ëœì­ì…˜** | `@Transactional` | âŒ ì—†ìŒ (ì›ìì  ë¬¸ì„œ ë‹¨ìœ„) |
| **Lazy Loading** | ì§€ì› (`FetchType.LAZY`) | âŒ ì—†ìŒ |
| **ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸** | 1ì°¨ ìºì‹œ, ë³€ê²½ ê°ì§€ | âŒ ì—†ìŒ |
| **Auto DDL** | `spring.jpa.hibernate.ddl-auto` | ì¸ë±ìŠ¤ ìë™ ìƒì„± (ê¸°ë³¸ê°’) |
| **Auditing** | `@CreatedDate`, `@LastModifiedDate` | ë™ì¼í•˜ê²Œ ì§€ì› |
| **ì¿¼ë¦¬ ë©”ì„œë“œ** | `findByXxx` | ë™ì¼í•˜ê²Œ ì§€ì› |
| **Native Query** | JPQL, Native SQL | Elasticsearch Query DSL |

### âš ï¸ Elasticsearchì—ì„œ ì£¼ì˜í•  ì 
1. **JOINì´ ì—†ë‹¤**: RDBì²˜ëŸ¼ í…Œì´ë¸” ê°„ JOINì„ í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë¹„ì •ê·œí™”í•˜ê±°ë‚˜ IDë¡œ ì°¸ì¡° í›„ ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ ì¡°í•©í•©ë‹ˆë‹¤.
2. **íŠ¸ëœì­ì…˜ì´ ì—†ë‹¤**: ì—¬ëŸ¬ ë¬¸ì„œë¥¼ ë¬¶ì–´ì„œ ë¡¤ë°±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë‹¨ì¼ ë¬¸ì„œ ë‹¨ìœ„ë¡œ ì›ìì„±ì´ ë³´ì¥ë©ë‹ˆë‹¤.
3. **Near Real-time**: ë¬¸ì„œ ì €ì¥ í›„ ì¦‰ì‹œ ê²€ìƒ‰ë˜ì§€ ì•Šì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤ (ì•½ 1ì´ˆ refresh ê°„ê²©).
4. **Text vs Keyword**: ì „ë¬¸ ê²€ìƒ‰ìš© `Text`ì™€ ì •í™• ë§¤ì¹­ìš© `Keyword`ë¥¼ êµ¬ë¶„í•´ì„œ ì‚¬ìš©í•´ì•¼ í•©ë‹ˆë‹¤.

---

# 1ë¶€: í”„ë¡œì íŠ¸ ì„¸íŒ…

# 1ê°•
## Spring Boot í”„ë¡œì íŠ¸ ìƒì„±
- [ì»¤ë°‹ c001](https://github.com/farrar142-examples/p-14646-1/commit/c001)
    - [íŠ¸ë¦¬ c001](https://github.com/farrar142-examples/p-14646-1/tree/c001)

## ì‘ì—…
### ì‘ì—… 1: Spring Boot í”„ë¡œì íŠ¸ ì´ˆê¸° ì„¤ì •
- Spring Boot 4.0.0 ê¸°ë°˜ì˜ ë°±ì—”ë“œ í”„ë¡œì íŠ¸ë¥¼ ìƒì„±í•œë‹¤.
- Java 25ë¥¼ ì–¸ì–´ ë²„ì „ìœ¼ë¡œ ì„¤ì •í•œë‹¤.
- Gradleì„ ë¹Œë“œ ë„êµ¬ë¡œ ì‚¬ìš©í•˜ë©° Kotlin DSL(build.gradle.kts)ì„ ì‚¬ìš©í•œë‹¤.

### ì‘ì—… 2: ì£¼ìš” ì˜ì¡´ì„± ì¶”ê°€ (`build.gradle.kts`)
```kotlin
plugins {
	java
	id("org.springframework.boot") version "4.0.0"
	id("io.spring.dependency-management") version "1.1.7"
}

group = "com"
version = "0.0.1-SNAPSHOT"

java {
	toolchain {
		languageVersion = JavaLanguageVersion.of(25)
	}
}

repositories {
	mavenCentral()
}

dependencies {
	implementation("org.springframework.boot:spring-boot-starter-data-elasticsearch")
	implementation("org.springframework.boot:spring-boot-starter-webmvc")
	testImplementation("org.springframework.boot:spring-boot-starter-data-elasticsearch-test")
	testImplementation("org.springframework.boot:spring-boot-starter-webmvc-test")
	testRuntimeOnly("org.junit.platform:junit-platform-launcher")
}

tasks.withType<Test> {
	useJUnitPlatform()
}
```
- `spring-boot-starter-web`: Spring MVC ê¸°ë°˜ ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ìœ„í•œ ìŠ¤íƒ€í„°
- `spring-boot-starter-data-elasticsearch`: Spring Data Elasticsearch ìŠ¤íƒ€í„°
    - JPAê°€ RDBë¥¼ ì¶”ìƒí™”í•˜ë“¯ì´, Spring Data ElasticsearchëŠ” Elasticsearchë¥¼ ì¶”ìƒí™”í•˜ì—¬ Repository íŒ¨í„´ìœ¼ë¡œ ë°ì´í„°ì— ì ‘ê·¼í•  ìˆ˜ ìˆê²Œ í•´ì¤€ë‹¤.

> ğŸ’¡ **JPAì™€ì˜ ì°¨ì´ì **: JPAì—ì„œëŠ” `spring-boot-starter-data-jpa`ì™€ DB ë“œë¼ì´ë²„(H2, MySQL ë“±)ê°€ í•„ìš”í•˜ì§€ë§Œ, ElasticsearchëŠ” ë‹¨ì¼ ìŠ¤íƒ€í„°ë¡œ í´ë¼ì´ì–¸íŠ¸ê¹Œì§€ í¬í•¨ë©ë‹ˆë‹¤.

### ì‘ì—… 3: Git ì„¤ì •
- `.gitignore`: Gradle ë¹Œë“œ íŒŒì¼, IDE ì„¤ì •, ë¹Œë“œ ì‚°ì¶œë¬¼ ì œì™¸
- `.gitattributes`: ë¼ì¸ ì—”ë”© ì„¤ì • (gradlewëŠ” LF, *.batëŠ” CRLF)


# 2ê°•
## ì• í”Œë¦¬ì¼€ì´ì…˜ ê¸°ë³¸ ì„¤ì •
- [ì»¤ë°‹ c002](https://github.com/farrar142-examples/p-14646-1/commit/c002)
    - [íŠ¸ë¦¬ c002](https://github.com/farrar142-examples/p-14646-1/tree/c002)

## ì‘ì—…
### ì‘ì—… 1: ì• í”Œë¦¬ì¼€ì´ì…˜ ì„¤ì • (`application.yaml`)
```yaml
spring:
  application:
    name: back
  output:
    ansi:
      enabled: ALWAYS
logging:
  level:
    com:
      back: debug
server:
  port: 8080
```
- `spring.output.ansi.enabled`: ì½˜ì†” ì¶œë ¥ ì‹œ ANSI ì»¬ëŸ¬ë¥¼ í•­ìƒ í™œì„±í™” (`ALWAYS`)
- `logging.level.com.back`: `com.back` íŒ¨í‚¤ì§€ì˜ ë¡œê·¸ ë ˆë²¨ì„ `debug`ë¡œ ì„¤ì •
- `server.port`: ì„œë²„ í¬íŠ¸ë¥¼ `8080`ìœ¼ë¡œ ì§€ì •


# 3ê°•
## Jackson ì„¤ì •
- [ì»¤ë°‹ c003](https://github.com/farrar142-examples/p-14646-1/commit/c003)
    - [íŠ¸ë¦¬ c003](https://github.com/farrar142-examples/p-14646-1/tree/c003)

## ì‘ì—…
### ì‘ì—… 1: Jackson ì§ë ¬í™” ì„¤ì • (`application.yaml`)
```yaml
spring:
  jackson:
    serialization:
      fail-on-empty-beans: false
```
- `spring.jackson.serialization.fail-on-empty-beans`: ë¹ˆ ê°ì²´ ì§ë ¬í™” ì‹œ ì˜ˆì™¸ ë°œìƒ ë°©ì§€ (`false`)


# 4ê°•
## í”„ë¡œí•„ ì„¤ì •
- [ì»¤ë°‹ c004](https://github.com/farrar142-examples/p-14646-1/commit/c004)
    - [íŠ¸ë¦¬ c004](https://github.com/farrar142-examples/p-14646-1/tree/c004)

## ì‘ì—…
### ì‘ì—… 1: í™œì„± í”„ë¡œí•„ ì„¤ì • (`application.yaml`)
```yaml
spring:
  profiles:
    active: dev
```
- `spring.profiles.active`: ê¸°ë³¸ í”„ë¡œí•„ì„ `dev`ë¡œ ì„¤ì •


# 5ê°•
## Docker í™˜ê²½ ì„¤ì •
- [ì»¤ë°‹ c005](https://github.com/farrar142-examples/p-14646-1/commit/c005)
    - [íŠ¸ë¦¬ c005](https://github.com/farrar142-examples/p-14646-1/tree/c005)

## ì‘ì—…
### ì‘ì—… 1: Dockerfile ì‘ì„±
```dockerfile
FROM elasticsearch:9.2.2
RUN bin/elasticsearch-plugin install analysis-nori
```
- Elasticsearch 9.2.2 ì´ë¯¸ì§€ ê¸°ë°˜
- `analysis-nori` í”ŒëŸ¬ê·¸ì¸ ì„¤ì¹˜ (í•œêµ­ì–´ í˜•íƒœì†Œ ë¶„ì„ê¸°)

### ì‘ì—… 2: Docker Compose ì„¤ì • (`compose.yml`)
```yaml
services:
  elasticsearch:
    build: .
    image: elasticsearch:nori
    ports:
      - "9200:9200"
    environment:
      - discovery.type=single-node
```
- Elasticsearch ì„œë¹„ìŠ¤ êµ¬ì„±
- í¬íŠ¸ `9200` ë…¸ì¶œ
- `discovery.type=single-node`: ë‹¨ì¼ ë…¸ë“œ ëª¨ë“œ
- `xpack.security.enabled=false`: ë³´ì•ˆ ê¸°ëŠ¥ ë¹„í™œì„±í™”


# 6ê°•
## ê°œë°œ í™˜ê²½ Elasticsearch ì—°ê²° ì„¤ì •
- [ì»¤ë°‹ c006](https://github.com/farrar142-examples/p-14646-1/commit/c006)
    - [íŠ¸ë¦¬ c006](https://github.com/farrar142-examples/p-14646-1/tree/c006)

## ì‘ì—…
### ì‘ì—… 1: ê°œë°œ í™˜ê²½ ì„¤ì • (`application-dev.yaml`)
```yaml
spring:
  elasticsearch:
    uris: localhost:9200
```
- `spring.elasticsearch.uris`: `localhost:9200`ìœ¼ë¡œ Elasticsearch ì—°ê²° ì£¼ì†Œ ì„¤ì •


# 7ê°•
## ì´ˆê¸° ë°ì´í„° ì„¤ì • í´ë˜ìŠ¤ ìƒì„±
- [ì»¤ë°‹ c007](https://github.com/farrar142-examples/p-14646-1/commit/c007)
    - [íŠ¸ë¦¬ c007](https://github.com/farrar142-examples/p-14646-1/tree/c007)

## ì‘ì—…
### ì‘ì—… 1: BaseInitData í´ë˜ìŠ¤ ìƒì„±
```java
@Configuration
public class BaseInitData {

    @Bean
    public ApplicationRunner baseInitDataRunner (){
        return args->{
            System.out.println("ApplicationRunner ë¹ˆì€ ìŠ¤í”„ë§ì— ë“±ë¡ë˜ë©´ ìë™ìœ¼ë¡œ ì‹¤í–‰ë©ë‹ˆë‹¤");
        };
    }
}
```
- `@Configuration` ì–´ë…¸í…Œì´ì…˜ìœ¼ë¡œ ì„¤ì • í´ë˜ìŠ¤ ì§€ì •
- `ApplicationRunner` Beanì„ í†µí•´ ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘ ì‹œ ì´ˆê¸°í™” ë¡œì§ ì‹¤í–‰


# 8ê°•
## Lombok ì˜ì¡´ì„± ì¶”ê°€
- [ì»¤ë°‹ c008](https://github.com/farrar142-examples/p-14646-1/commit/c008)
    - [íŠ¸ë¦¬ c008](https://github.com/farrar142-examples/p-14646-1/tree/c008)

## ì‘ì—…
### ì‘ì—… 1: Lombok ì˜ì¡´ì„± ì¶”ê°€ (`build.gradle.kts`)
- `compileOnly("org.projectlombok:lombok")`
- `annotationProcessor("org.projectlombok:lombok")`

### ì‘ì—… 2: BaseInitDataì— Lombok ì ìš©
```java
@Configuration
@Slf4j
public class BaseInitData {

    @Bean
    public ApplicationRunner baseInitDataRunner (){
        return args->{
            log.debug("ApplicationRunner ë¹ˆì€ ìŠ¤í”„ë§ì— ë“±ë¡ë˜ë©´ ìë™ìœ¼ë¡œ ì‹¤í–‰ë©ë‹ˆë‹¤");
        };
    }
}
```
- `@Slf4j` ì–´ë…¸í…Œì´ì…˜ ì¶”ê°€ë¡œ ë¡œê¹… ê¸°ëŠ¥ í™œì„±í™”


---

# 2ë¶€: Post CRUD (Service Layer)

# 9ê°•
## PostService ìƒì„± ë° count ë©”ì„œë“œ êµ¬í˜„
- [ì»¤ë°‹ c009](https://github.com/farrar142-examples/p-14646-1/commit/c009)
    - [íŠ¸ë¦¬ c009](https://github.com/farrar142-examples/p-14646-1/tree/c009)

## ì‘ì—…
### ì‘ì—… 1: PostService í´ë˜ìŠ¤ ìƒì„±
```java
@Service
public class PostService {
    public long count() {
        return 0;
    }
}
```
- `@Service` ì–´ë…¸í…Œì´ì…˜ìœ¼ë¡œ ì„œë¹„ìŠ¤ ì»´í¬ë„ŒíŠ¸ ì§€ì •
- `count()` ë©”ì„œë“œ ì¶”ê°€ (ì´ˆê¸° êµ¬í˜„ì€ 0 ë°˜í™˜ - ì•„ì§ Repositoryê°€ ì—†ìœ¼ë¯€ë¡œ)

### ì‘ì—… 2: BaseInitDataì— PostService ì£¼ì…
- `@RequiredArgsConstructor`ë¡œ ìƒì„±ì ê¸°ë°˜ ì˜ì¡´ì„± ì£¼ì…
- ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘ ì‹œ Post ê°œìˆ˜ë¥¼ ë¡œê¹…í•˜ì—¬ ì—°ê²° í™•ì¸


# 10ê°•
## Post ì—”í‹°í‹° ë° Repository ìƒì„±
- [ì»¤ë°‹ c010](https://github.com/farrar142-examples/p-14646-1/commit/c010)
    - [íŠ¸ë¦¬ c010](https://github.com/farrar142-examples/p-14646-1/tree/c010)

## ì‘ì—…
### ì‘ì—… 1: Post Document í´ë˜ìŠ¤ ìƒì„±
```java
@Document(indexName = "posts")
public class Post {
    @Id
    private String id;
    @Field(type= FieldType.Text)
    private String title;
    @Field(type= FieldType.Text)
    private String content;
    @Field(type= FieldType.Keyword)
    private String author;

    @Field(
            type = FieldType.Date,
            format = DateFormat.date_time
    )
    private OffsetDateTime createdAt;

    @Field(
            type = FieldType.Date,
            format = DateFormat.date_time
    )
    private OffsetDateTime lastModifiedAt;
}
```
- `@Document(indexName = "posts")`: Elasticsearchì— `posts` ì¸ë±ìŠ¤ ìƒì„±
    - JPAì˜ `@Entity` + `@Table(name="posts")`ì— í•´ë‹¹
- í•„ë“œ ì •ì˜ ë° íƒ€ì… ë§¤í•‘:
    - `id`: ë¬¸ì„œ ì‹ë³„ì (`@Id`)
        - âš ï¸ **JPAì™€ì˜ ì°¨ì´**: Elasticsearchì—ì„œëŠ” IDê°€ ë³´í†µ `String` íƒ€ì…ì…ë‹ˆë‹¤. ìë™ ìƒì„± ì‹œ UUID í˜•íƒœì˜ ë¬¸ìì—´ì´ í• ë‹¹ë©ë‹ˆë‹¤.
    - `title`: ì œëª© (`FieldType.Text`) - ì „ë¬¸ ê²€ìƒ‰ ê°€ëŠ¥
    - `content`: ë‚´ìš© (`FieldType.Text`) - ì „ë¬¸ ê²€ìƒ‰ ê°€ëŠ¥
    - `author`: ì‘ì„±ì (`FieldType.Keyword`) - ì •í™•í•œ ì¼ì¹˜ ê²€ìƒ‰ìš©
    - `createdAt`: ìƒì„±ì¼ì‹œ (`FieldType.Date`)
    - `lastModifiedAt`: ìˆ˜ì •ì¼ì‹œ (`FieldType.Date`)

> ğŸ’¡ **FieldType.Text vs FieldType.Keyword**
> - `Text`: í˜•íƒœì†Œ ë¶„ì„ë˜ì–´ ë¶€ë¶„ ê²€ìƒ‰ ê°€ëŠ¥ (ì˜ˆ: "Spring Boot" ê²€ìƒ‰ ì‹œ "Spring", "Boot" ê°ê° ë§¤ì¹­)
> - `Keyword`: ë¶„ì„ë˜ì§€ ì•Šê³  ì •í™•íˆ ì¼ì¹˜í•´ì•¼ ê²€ìƒ‰ (ì˜ˆ: ì´ë©”ì¼, ìƒíƒœê°’, ID ì°¸ì¡°ìš©)
>
> **RDB vs Elasticsearch ê²€ìƒ‰ ë°©ì‹ ë¹„êµ:**
> | ìƒí™© | RDB | Elasticsearch |
> |------|-----|---------------|
> | **ì •í™•í•œ ì¼ì¹˜ ê²€ìƒ‰** | `WHERE author = 'kim'` | `FieldType.Keyword` |
> | **ë¶€ë¶„ ë¬¸ìì—´ ê²€ìƒ‰** | `LIKE '%keyword%'` (ëŠë¦¼) | `FieldType.Text` (ë¹ ë¦„) |
> | **ì „ë¬¸ ê²€ìƒ‰** | FULLTEXT ì¸ë±ìŠ¤ (ì œí•œì ) | `FieldType.Text` (ê°•ë ¥) |
>
> **í•µì‹¬ ì°¨ì´:**
> - **RDB**: ë°ì´í„° ì €ì¥ í›„ì—ë„ ê²€ìƒ‰ ë°©ì‹ì„ **ì¿¼ë¦¬ ì‹œì ì—** ìœ ì—°í•˜ê²Œ ì„ íƒ (`=`, `LIKE`, `FULLTEXT`)
> - **Elasticsearch**: ê²€ìƒ‰ ë°©ì‹ì„ **ì €ì¥ ì‹œì ì—** í•„ë“œ íƒ€ì…ìœ¼ë¡œ ë¯¸ë¦¬ ê²°ì •í•´ì•¼ í•¨
> - Elasticsearchì—ì„œ í•„ë“œ íƒ€ì… ë³€ê²½ ì‹œ **ì¸ë±ìŠ¤ ì¬ìƒì„± í•„ìš”** (ë§ˆì´ê·¸ë ˆì´ì…˜)
>
> ë‘˜ ë‹¤ í•„ìš”í•˜ë©´ multi-field ì‚¬ìš©:
> ```java
> @MultiField(
>     mainField = @Field(type = FieldType.Text),
>     otherFields = @InnerField(suffix = "keyword", type = FieldType.Keyword)
> )
> private String title;  // titleë¡œ ì „ë¬¸ê²€ìƒ‰, title.keywordë¡œ ì •í™•ë§¤ì¹­
> ```

### ì‘ì—… 2: PostRepository ì¸í„°í˜ì´ìŠ¤ ìƒì„±
```java
public interface PostRepository extends ElasticsearchRepository<Post,String> {
}
```
- `ElasticsearchRepository<Post, String>` ìƒì†
    - ì²« ë²ˆì§¸ ì œë„¤ë¦­: ì—”í‹°í‹° íƒ€ì…
    - ë‘ ë²ˆì§¸ ì œë„¤ë¦­: ID íƒ€ì… (ElasticsearchëŠ” String ID ì‚¬ìš©)
    - JPAì˜ `JpaRepository<Post, Long>`ì— í•´ë‹¹

> ğŸ’¡ **ê¸°ë³¸ ì œê³µ ë©”ì„œë“œ ë¹„êµ**
> | ë©”ì„œë“œ | JpaRepository | ElasticsearchRepository |
> |--------|---------------|-------------------------|
> | `save(entity)` | âœ… | âœ… |
> | `findById(id)` | âœ… | âœ… |
> | `findAll()` | âœ… (List ë°˜í™˜) | âœ… (Iterable ë°˜í™˜) |
> | `delete(entity)` | âœ… | âœ… |
> | `count()` | âœ… | âœ… |
> | `existsById(id)` | âœ… | âœ… |
> | `flush()` | âœ… | âŒ ì—†ìŒ |
> | `saveAndFlush()` | âœ… | âŒ ì—†ìŒ |

### ì‘ì—… 3: BackApplication ì„¤ì •
- `@EnableElasticsearchRepositories`: Elasticsearch Repository ìë™ ìŠ¤ìº” í™œì„±í™”

### ì‘ì—… 4: PostServiceì— Repository ì—°ê²°
- `PostRepository` ì˜ì¡´ì„± ì£¼ì…
- `count()` ë©”ì„œë“œë¥¼ `postRepository.count()` í˜¸ì¶œë¡œ ë³€ê²½


# 11ê°•
## Post ìƒì„± ê¸°ëŠ¥ êµ¬í˜„ (Create)
- [ì»¤ë°‹ c011](https://github.com/farrar142-examples/p-14646-1/commit/c011)
    - [íŠ¸ë¦¬ c011](https://github.com/farrar142-examples/p-14646-1/tree/c011)

## ì‘ì—…
### ì‘ì—… 1: Post ìƒì„±ì ì¶”ê°€
- `title`, `content`, `author`ë¥¼ ë°›ëŠ” ìƒì„±ì êµ¬í˜„
- `createdAt`, `lastModifiedAt`ì„ `OffsetDateTime.now()`ë¡œ ìë™ ì„¤ì •

### ì‘ì—… 2: PostService.create() ë©”ì„œë“œ êµ¬í˜„
```java
public Post create(String title, String content, String author) {
    Post post = new Post(title, content, author);
    return postRepository.save(post);
}
```

> âš ï¸ **JPAì™€ì˜ ì°¨ì´ì  - ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ ì—†ìŒ**
> - JPA: `save()` í›„ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì—ì„œ ê´€ë¦¬ë˜ë©°, ê°™ì€ íŠ¸ëœì­ì…˜ ë‚´ì—ì„œ ë³€ê²½ ê°ì§€(Dirty Checking)ë¡œ ìë™ ì €ì¥
> - Elasticsearch: ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ê°€ ì—†ìœ¼ë¯€ë¡œ **ë³€ê²½ ì‹œë§ˆë‹¤ `save()` í˜¸ì¶œ í•„ìˆ˜**
> ```java
> // JPA - ë³€ê²½ ê°ì§€ë¡œ ìë™ ì €ì¥
> Post post = postRepository.findById(id).get();
> post.setTitle("new title"); // íŠ¸ëœì­ì…˜ ì¢…ë£Œ ì‹œ ìë™ UPDATE
> 
> // Elasticsearch - ëª…ì‹œì  save() í•„ìš”
> Post post = postRepository.findById(id).get();
> post.setTitle("new title");
> postRepository.save(post); // ë°˜ë“œì‹œ í˜¸ì¶œí•´ì•¼ ì €ì¥ë¨
> ```

### ì‘ì—… 3: BaseInitDataì— ìƒ˜í”Œ ë°ì´í„° ìƒì„± ë¡œì§ ì¶”ê°€
- Postê°€ ì—†ì„ ê²½ìš°(`count() == 0`) 10ê°œì˜ ìƒ˜í”Œ Post ìƒì„±
- ê°œë°œ/í…ŒìŠ¤íŠ¸ í™˜ê²½ì—ì„œ ì´ˆê¸° ë°ì´í„° í™•ë³´ ëª©ì 


# 12ê°•
## Post ì „ì²´ ì¡°íšŒ ê¸°ëŠ¥ êµ¬í˜„ (Read - List)
- [ì»¤ë°‹ c012](https://github.com/farrar142-examples/p-14646-1/commit/c012)
    - [íŠ¸ë¦¬ c012](https://github.com/farrar142-examples/p-14646-1/tree/c012)

## ì‘ì—…
### ì‘ì—… 1: PostRepository.findAll() ë©”ì„œë“œ ì¶”ê°€
```java
public interface PostRepository extends ElasticsearchRepository<Post,String> {
    List<Post> findAll();
}
```
- `List<Post> findAll()` ë©”ì„œë“œ ì‹œê·¸ë‹ˆì²˜ ì„ ì–¸
- Spring Dataê°€ ìë™ìœ¼ë¡œ êµ¬í˜„ì²´ ìƒì„±

> ğŸ’¡ **ì™œ findAll()ì„ ì¬ì„ ì–¸í•˜ë‚˜ìš”?**
> - `ElasticsearchRepository`ì˜ ê¸°ë³¸ `findAll()`ì€ `Iterable<Post>`ë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤.
> - `List<Post>` ë°˜í™˜ íƒ€ì…ìœ¼ë¡œ ì¬ì„ ì–¸í•˜ë©´ Spring Dataê°€ ìë™ìœ¼ë¡œ Listë¡œ ë³€í™˜í•´ì¤ë‹ˆë‹¤.
> - JPAì˜ `JpaRepository`ëŠ” ê¸°ë³¸ìœ¼ë¡œ `List<T>`ë¥¼ ë°˜í™˜í•˜ë¯€ë¡œ ì¬ì„ ì–¸ì´ í•„ìš” ì—†ìŠµë‹ˆë‹¤.

### ì‘ì—… 2: PostService.findAll() ë©”ì„œë“œ êµ¬í˜„
```java
public List<Post> findAll() {
    return postRepository.findAll();
}
```
- Repositoryì˜ findAll() í˜¸ì¶œí•˜ì—¬ ì „ì²´ ëª©ë¡ ë°˜í™˜

### ì‘ì—… 3: BaseInitData work2 ì¶”ê°€
- ê¸°ì¡´ Post ì „ì²´ ì¡°íšŒ ë° ë¡œê¹…ìœ¼ë¡œ ì €ì¥ëœ ë°ì´í„° í™•ì¸


# 13ê°•
## Post ë‹¨ê±´ ì¡°íšŒ ê¸°ëŠ¥ êµ¬í˜„ (Read - Single)
- [ì»¤ë°‹ c013](https://github.com/farrar142-examples/p-14646-1/commit/c013)
    - [íŠ¸ë¦¬ c013](https://github.com/farrar142-examples/p-14646-1/tree/c013)

## ì‘ì—…
### ì‘ì—… 1: PostService.findById() ë©”ì„œë“œ êµ¬í˜„
```java
public Optional<Post> findById(String id) {
    return postRepository.findById(id);
}
```
- `Optional<Post>` ë°˜í™˜ íƒ€ì…ìœ¼ë¡œ êµ¬í˜„
- ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ID ì¡°íšŒ ì‹œ `Optional.empty()` ë°˜í™˜

### ì‘ì—… 2: BaseInitData work3 ì¶”ê°€
- Post ë‹¨ê±´ ì¡°íšŒ í…ŒìŠ¤íŠ¸ ë¡œì§ ì¶”ê°€


# 14ê°•
## ì»¤ìŠ¤í…€ ì˜ˆì™¸ í´ë˜ìŠ¤ ìƒì„±
- [ì»¤ë°‹ c014](https://github.com/farrar142-examples/p-14646-1/commit/c014)
    - [íŠ¸ë¦¬ c014](https://github.com/farrar142-examples/p-14646-1/tree/c014)

## ì‘ì—…
### ì‘ì—… 1: DomainException í´ë˜ìŠ¤ ìƒì„±
```java
public class DomainException extends RuntimeException {
    String resultCode;
    public DomainException(String resultCode, String message) {
        super(message);
        this.resultCode = resultCode;
    }
}
```
- `RuntimeException` ìƒì† (Unchecked Exception)
- `resultCode`: ì—ëŸ¬ ì½”ë“œ (ì˜ˆ: "404", "400")
- `message`: ì—ëŸ¬ ë©”ì‹œì§€

### ì‘ì—… 2: NotFoundException í´ë˜ìŠ¤ ìƒì„±
```java
public class NotFoundException extends DomainException {
    public NotFoundException(String message) {
        super("404", message);
    }
}
```
- `DomainException` ìƒì†
- ìƒì„±ìì—ì„œ resultCodeë¥¼ "404"ë¡œ ê³ ì •
- ë¦¬ì†ŒìŠ¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ì„ ë•Œ ì‚¬ìš©


# 15ê°•
## Post ë‹¨ê±´ ì¡°íšŒ ì˜ˆì™¸ ì²˜ë¦¬ ì ìš©
- [ì»¤ë°‹ c015](https://github.com/farrar142-examples/p-14646-1/commit/c015)
    - [íŠ¸ë¦¬ c015](https://github.com/farrar142-examples/p-14646-1/tree/c015)

## ì‘ì—…
### ì‘ì—… 1: Post Documentì— @Getter ì¶”ê°€
- Lombok `@Getter` ì–´ë…¸í…Œì´ì…˜ìœ¼ë¡œ getter ë©”ì„œë“œ ìë™ ìƒì„±

### ì‘ì—… 2: PostService.findById() ì˜ˆì™¸ ì²˜ë¦¬ ê°œì„ 
```java
public Post findById(String id) {
    return postRepository.findById(id).orElseThrow(()->new NotFoundException("Post not found with id: " + id));
}
```

### ì‘ì—… 3: BaseInitData work3 ê°œì„ 
- IDë¡œ ë‹¨ê±´ ì¡°íšŒ í›„ ê²°ê³¼ ë¡œê¹…


# 16ê°•
## Post ìˆ˜ì • ê¸°ëŠ¥ êµ¬í˜„ (Update)
- [ì»¤ë°‹ c016](https://github.com/farrar142-examples/p-14646-1/commit/c016)
    - [íŠ¸ë¦¬ c016](https://github.com/farrar142-examples/p-14646-1/tree/c016)

## ì‘ì—…
### ì‘ì—… 1: Post Documentì— @Data ì ìš©
- `@Getter`ë¥¼ `@Data`ë¡œ ë³€ê²½
- `@Data`ëŠ” `@Getter`, `@Setter`, `@ToString`, `@EqualsAndHashCode` í¬í•¨

### ì‘ì—… 2: PostService.update() ë©”ì„œë“œ êµ¬í˜„
```java
public Post update(String id, String title, String content) {
    Post post = findById(id);
    if (title != null){
        post.setTitle(title);
    }
    if (content != null){
        post.setContent(content);
    }
    post.setLastModifiedAt(java.time.OffsetDateTime.now());
    return postRepository.save(post);
}
```


### ì‘ì—… 3: BaseInitData work4 ì¶”ê°€
- Post ìˆ˜ì • í…ŒìŠ¤íŠ¸ ë¡œì§


# 17ê°•
## Post ì‚­ì œ ê¸°ëŠ¥ êµ¬í˜„ (Delete)
- [ì»¤ë°‹ c017](https://github.com/farrar142-examples/p-14646-1/commit/c017)
    - [íŠ¸ë¦¬ c017](https://github.com/farrar142-examples/p-14646-1/tree/c017)

## ì‘ì—…
### ì‘ì—… 1: PostService.delete() ë©”ì„œë“œ êµ¬í˜„
```java
public void delete(String id) {
    Post post = findById(id);
    postRepository.delete(post);
}
```

### ì‘ì—… 2: BaseInitData work5 ì¶”ê°€
- Post ì‚­ì œ í…ŒìŠ¤íŠ¸ ë¡œì§


# 18ê°•
## Auditing ì„¤ì •
- [ì»¤ë°‹ c018](https://github.com/farrar142-examples/p-14646-1/commit/c018)
    - [íŠ¸ë¦¬ c018](https://github.com/farrar142-examples/p-14646-1/tree/c018)

## ì‘ì—…
### ì‘ì—… 1: AuditingConfig í´ë˜ìŠ¤ ìƒì„±
```java
@Configuration
public class AuditingConfig {
    @Bean
    public DateTimeProvider dateTimeProvider() {
        return () -> Optional.of(OffsetDateTime.now());
    }
}
```
- `DateTimeProvider` Bean ë“±ë¡
- `OffsetDateTime` íƒ€ì… ì§€ì›ì„ ìœ„í•œ ì„¤ì •

### ì‘ì—… 2: BackApplicationì— Auditing í™œì„±í™”
- `@EnableElasticsearchAuditing` ì–´ë…¸í…Œì´ì…˜ ì¶”ê°€
- `@CreatedDate`, `@LastModifiedDate` ì–´ë…¸í…Œì´ì…˜ ìë™ ì²˜ë¦¬
- JPAì˜ `@EnableJpaAuditing`ê³¼ ë™ì¼í•œ ì—­í• 

### ì‘ì—… 3: Post Documentì— Persistable êµ¬í˜„
- `Persistable<String>` ì¸í„°í˜ì´ìŠ¤ êµ¬í˜„
- `isNew()` ë©”ì„œë“œ: IDê°€ nullì´ê±°ë‚˜ ë‚ ì§œ í•„ë“œê°€ ëª¨ë‘ nullì´ë©´ ìƒˆ ì—”í‹°í‹°ë¡œ íŒë‹¨
- ElasticsearchëŠ” ID ìœ ë¬´ë¡œ insert/updateë¥¼ êµ¬ë¶„í•˜ì§€ ì•Šìœ¼ë¯€ë¡œ í•„ìš”

> âš ï¸ **Persistable ì¸í„°í˜ì´ìŠ¤ê°€ í•„ìš”í•œ ì´ìœ **
> - JPA: ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ê°€ ì—”í‹°í‹°ì˜ ìƒíƒœ(transient, managed, detached)ë¥¼ ê´€ë¦¬
> - Elasticsearch: ì˜ì†ì„± ì»¨í…ŒìŠ¤íŠ¸ê°€ ì—†ìœ¼ë¯€ë¡œ `isNew()` ë©”ì„œë“œë¡œ ìƒˆ ë¬¸ì„œì¸ì§€ íŒë‹¨
> - `@CreatedDate`ê°€ ì˜¬ë°”ë¥´ê²Œ ì„¤ì •ë˜ë ¤ë©´ `isNew()`ê°€ ì ì ˆíˆ êµ¬í˜„ë˜ì–´ì•¼ í•¨
> - IDê°€ ì¡´ì¬í•˜ëŠ”ë° ìƒˆ ë¬¸ì„œì¼ ìˆ˜ ìˆìœ¼ë¯€ë¡œ(ì‚¬ìš©ì ì§€ì • ID), ë‚ ì§œ í•„ë“œë„ í•¨ê»˜ í™•ì¸

### ì‘ì—… 4: PostServiceì—ì„œ ìˆ˜ë™ lastModifiedAt ì„¤ì • ì œê±°
- Auditingì´ ìë™ìœ¼ë¡œ ì²˜ë¦¬í•˜ë¯€ë¡œ `setLastModifiedAt()` í˜¸ì¶œ ì œê±°


# 19ê°•
## BaseDocument ì¶”ìƒ í´ë˜ìŠ¤ ì¶”ì¶œ (ë¦¬íŒ©í† ë§)
- [ì»¤ë°‹ c019](https://github.com/farrar142-examples/p-14646-1/commit/c019)
    - [íŠ¸ë¦¬ c019](https://github.com/farrar142-examples/p-14646-1/tree/c019)

## ì‘ì—…
### ì‘ì—… 1: BaseDocument ì¶”ìƒ í´ë˜ìŠ¤ ìƒì„±
```java
@Getter
@ToString
public class BaseDocument<ID> implements Persistable<ID> {

    @Id
    private ID id;

    @Field(
            type = FieldType.Date,
            format = DateFormat.date_time
    )
    @CreatedDate
    private OffsetDateTime createdAt;

    @Field(
            type = FieldType.Date,
            format = DateFormat.date_time
    )
    @LastModifiedDate
    private OffsetDateTime lastModifiedAt;

    @Override
    public boolean isNew() {
        return id == null || (createdAt == null && lastModifiedAt == null);
    }

    @Override
    public boolean equals(Object o) {
        if (o == null || getClass() != o.getClass()) return false;
        BaseDocument<?> that = (BaseDocument<?>) o;
        return Objects.equals(id, that.id);
    }

    @Override
    public int hashCode() {
        return Objects.hashCode(id);
    }
}
```

> ğŸ’¡ **JPAì˜ BaseEntityì™€ ë¹„êµ**
> ```java
> // JPA BaseEntity - Persistable í•„ìš” ì—†ìŒ
> @MappedSuperclass
> @EntityListeners(AuditingEntityListener.class)
> public abstract class BaseEntity {
>     @Id @GeneratedValue(strategy = GenerationType.IDENTITY)
>     private Long id;
>     
>     @CreatedDate
>     private LocalDateTime createdAt;
>     
>     @LastModifiedDate
>     private LocalDateTime lastModifiedAt;
> }
> ```
>
> **ì£¼ìš” ì°¨ì´ì :**
> | í•­ëª© | JPA | Elasticsearch |
> |------|-----|---------------|
> | ìƒì† ì–´ë…¸í…Œì´ì…˜ | `@MappedSuperclass` | ì—†ìŒ (ì¼ë°˜ ìƒì†) |
> | ID ìƒì„± | `@GeneratedValue` | ìë™ UUID (ì„¤ì • ë¶ˆí•„ìš”) |
> | Persistable | ë³´í†µ ë¶ˆí•„ìš” | **í•„ìˆ˜** (`isNew()` êµ¬í˜„) |
> | í•„ë“œ ë§¤í•‘ | ìë™ | `@Field(type, format)` í•„ìš” |

- ëª¨ë“  Documentì˜ ê³µí†µ í•„ë“œë¥¼ ì¶”ì¶œ:
    - `id`: ë¬¸ì„œ ì‹ë³„ì
    - `createdAt`: ìƒì„±ì¼ì‹œ (`@CreatedDate`)
    - `lastModifiedAt`: ìˆ˜ì •ì¼ì‹œ (`@LastModifiedDate`)
- `Persistable<ID>` ì¸í„°í˜ì´ìŠ¤ êµ¬í˜„
- `equals()`, `hashCode()`ë¥¼ ID ê¸°ë°˜ìœ¼ë¡œ ì˜¤ë²„ë¼ì´ë“œ

### ì‘ì—… 2: Post Document ë¦¬íŒ©í† ë§
- `BaseDocument<String>` ìƒì†ìœ¼ë¡œ ë³€ê²½
- `@EqualsAndHashCode(callSuper = true)`: ë¶€ëª¨ í´ë˜ìŠ¤ í•„ë“œ í¬í•¨
- `@ToString(callSuper = true)`: ë¶€ëª¨ í´ë˜ìŠ¤ í•„ë“œ í¬í•¨


---

# 3ë¶€: Comment CRUD (Service Layer)

# 20ê°•
## Comment ì—”í‹°í‹° ë° ê¸°ë³¸ êµ¬ì¡° ìƒì„±
- [ì»¤ë°‹ c020](https://github.com/farrar142-examples/p-14646-1/commit/c020)
    - [íŠ¸ë¦¬ c020](https://github.com/farrar142-examples/p-14646-1/tree/c020)

## ì‘ì—…
### ì‘ì—… 1: Comment Document í´ë˜ìŠ¤ ìƒì„±
```java
@Document(indexName = "comments")
@Data
@ToString(callSuper = true)
@EqualsAndHashCode(callSuper = true)
public class Comment extends BaseDocument<String> {

    @Field(type = FieldType.Keyword)
    private String postId;

    @Field(type = FieldType.Text)
    private String content;

    @Field(type = FieldType.Keyword)
    private String author;

    public Comment(String postId, String content, String author) {
        this.postId = postId;
        this.content = content;
        this.author = author;
    }
}
```
- `BaseDocument<String>` ìƒì†ìœ¼ë¡œ ê³µí†µ í•„ë“œ ì¬ì‚¬ìš©
- `@Document(indexName = "comments")`: Elasticsearchì— `comments` ì¸ë±ìŠ¤ ìƒì„±
- í•„ë“œ ì •ì˜:
    - `postId`: ì—°ê´€ Post ID (`FieldType.Keyword`) - ì •í™•í•œ ì¼ì¹˜ ê²€ìƒ‰ìš©
    - `content`: ë‚´ìš© (`FieldType.Text`) - ì „ë¬¸ ê²€ìƒ‰ ê°€ëŠ¥
    - `author`: ì‘ì„±ì (`FieldType.Keyword`)

> âš ï¸ **JPAì™€ì˜ ì°¨ì´ì  - ê´€ê³„ ë§¤í•‘ ì—†ìŒ**
> - JPAì—ì„œëŠ” `@ManyToOne`ìœ¼ë¡œ Postì™€ ê´€ê³„ë¥¼ ë§¤í•‘:
    >   ```java
>   @ManyToOne(fetch = FetchType.LAZY)
>   @JoinColumn(name = "post_id")
>   private Post post;
>   ```
> - Elasticsearchì—ëŠ” **JOINì´ ì—†ìœ¼ë¯€ë¡œ IDë§Œ ì €ì¥**:
    >   ```java
>   @Field(type = FieldType.Keyword)
>   private String postId;  // ë‹¨ìˆœ ID ì°¸ì¡°
>   ```
> - Post ì •ë³´ê°€ í•„ìš”í•˜ë©´ ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ ë³„ë„ë¡œ ì¡°íšŒí•´ì•¼ í•©ë‹ˆë‹¤.
> - ë˜ëŠ” ë¹„ì •ê·œí™”í•˜ì—¬ Post ë°ì´í„°ë¥¼ Commentì— ë³µì‚¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤ (denormalization).

### ì‘ì—… 2: CommentRepository ì¸í„°í˜ì´ìŠ¤ ìƒì„±
```java
public interface CommentRepository extends ElasticsearchRepository<Comment,String> {
}
```
- `ElasticsearchRepository<Comment, String>` ìƒì†

### ì‘ì—… 3: CommentService í´ë˜ìŠ¤ ìƒì„±
```java
@Service
@RequiredArgsConstructor
public class CommentService {
    private final CommentRepository commentRepository;

    public long count() {
        return commentRepository.count();
    }
}
```
- `@Service` ì–´ë…¸í…Œì´ì…˜ìœ¼ë¡œ ì„œë¹„ìŠ¤ ì»´í¬ë„ŒíŠ¸ ì§€ì •
- `count()` ë©”ì„œë“œ êµ¬í˜„

### ì‘ì—… 4: BaseInitDataì— CommentService ì£¼ì…
- work6 ì¶”ê°€: Comment ê°œìˆ˜ ë¡œê¹…


# 21ê°•
## Comment ìƒì„± ê¸°ëŠ¥ êµ¬í˜„ (Create)
- [ì»¤ë°‹ c021](https://github.com/farrar142-examples/p-14646-1/commit/c021)
    - [íŠ¸ë¦¬ c021](https://github.com/farrar142-examples/p-14646-1/tree/c021)

## ì‘ì—…
### ì‘ì—… 1: CommentService.create() ë©”ì„œë“œ êµ¬í˜„
```java
public Comment create(Post post, String content, String author) {
    Comment comment = new Comment(post.getId(),content, author);
    return commentRepository.save(comment);
}
```
- Post ê°ì²´ë¥¼ ë°›ì•„ `post.getId()`ë¡œ postId ì„¤ì •
- Postì™€ Commentì˜ ëŠìŠ¨í•œ ì—°ê²° (ElasticsearchëŠ” JOINì´ ì—†ìŒ)

> âš ï¸ **FK ì œì•½ì¡°ê±´ì´ ì—†ìŠµë‹ˆë‹¤**
> - JPA: `@ManyToOne`ìœ¼ë¡œ ê´€ê³„ë¥¼ ë§¤í•‘í•˜ë©´ DBì—ì„œ FK ì œì•½ì¡°ê±´ìœ¼ë¡œ ë¬´ê²°ì„± ë³´ì¥
> - Elasticsearch: **postIdê°€ ì‹¤ì œë¡œ ì¡´ì¬í•˜ëŠ”ì§€ ê²€ì¦í•˜ì§€ ì•ŠìŒ**
> - ë”°ë¼ì„œ ì• í”Œë¦¬ì¼€ì´ì…˜ ë ˆë²¨ì—ì„œ Post ì¡´ì¬ ì—¬ë¶€ë¥¼ ë¨¼ì € í™•ì¸í•´ì•¼ í•©ë‹ˆë‹¤.
> ```java
> // Post ì—†ì´ Commentë¥¼ ìƒì„±í•˜ë©´ ê³ ì•„ Commentê°€ ë¨
> Comment orphan = new Comment("non-existent-post-id", "content", "author");
> commentRepository.save(orphan); // ì—ëŸ¬ ì—†ì´ ì €ì¥ë¨!
> ```

### ì‘ì—… 2: BaseInitData work6 í™•ì¥
- Commentê°€ ì—†ì„ ê²½ìš° 5ê°œì˜ ìƒ˜í”Œ Comment ìƒì„±
- ê° CommentëŠ” ìƒˆ Postì™€ ì—°ê²°


# 22ê°•
## Comment ì „ì²´ ì¡°íšŒ ê¸°ëŠ¥ êµ¬í˜„ (Read - List)
- [ì»¤ë°‹ c022](https://github.com/farrar142-examples/p-14646-1/commit/c022)
    - [íŠ¸ë¦¬ c022](https://github.com/farrar142-examples/p-14646-1/tree/c022)

## ì‘ì—…
### ì‘ì—… 1: CommentRepository.findAll() ë©”ì„œë“œ ì¶”ê°€
```java
public interface CommentRepository extends ElasticsearchRepository<Comment,String> {
    List<Comment> findAll();
}
```
- `List<Comment> findAll()` ì„ ì–¸

### ì‘ì—… 2: CommentService.findAll() ë©”ì„œë“œ êµ¬í˜„
```java
public List<Comment> findAll() {
    return commentRepository.findAll();
}
```
- Repositoryì˜ findAll í˜¸ì¶œí•˜ì—¬ ì „ì²´ ëª©ë¡ ë°˜í™˜

### ì‘ì—… 3: BaseInitData work7 ì¶”ê°€
- ê¸°ì¡´ Comment ì „ì²´ ì¡°íšŒ ë° ë¡œê¹…


# 23ê°•
## Comment ë‹¨ê±´ ì¡°íšŒ ê¸°ëŠ¥ êµ¬í˜„ (Read - Single)
- [ì»¤ë°‹ c023](https://github.com/farrar142-examples/p-14646-1/commit/c023)
    - [íŠ¸ë¦¬ c023](https://github.com/farrar142-examples/p-14646-1/tree/c023)

## ì‘ì—…
### ì‘ì—… 1: CommentService.findById() ë©”ì„œë“œ êµ¬í˜„
```java
public Comment findById(String id) {
    return commentRepository.findById(id).orElseThrow(()->new NotFoundException("Comment not found with id: " + id));
}
```

### ì‘ì—… 2: BaseInitData work8 ì¶”ê°€
- Comment ë‹¨ê±´ ì¡°íšŒ í…ŒìŠ¤íŠ¸ ë¡œì§


# 24ê°•
## Comment Postë³„ ì¡°íšŒ ê¸°ëŠ¥ êµ¬í˜„
- [ì»¤ë°‹ c024](https://github.com/farrar142-examples/p-14646-1/commit/c024)
    - [íŠ¸ë¦¬ c024](https://github.com/farrar142-examples/p-14646-1/tree/c024)

## ì‘ì—…
### ì‘ì—… 1: CommentRepository.findByPostId() ë©”ì„œë“œ ì¶”ê°€
```java
public interface CommentRepository extends ElasticsearchRepository<Comment,String> {
    List<Comment> findAll();
    List<Comment> findByPostId(String postId);
}
```
- `List<Comment> findByPostId(String postId)` ì„ ì–¸
- Spring Dataê°€ ë©”ì„œë“œ ì´ë¦„ì„ íŒŒì‹±í•˜ì—¬ ì¿¼ë¦¬ ìë™ ìƒì„±

> ğŸ’¡ **JPAì™€ ë™ì¼í•œ ì¿¼ë¦¬ ë©”ì„œë“œ ê·œì¹™**
> - Spring DataëŠ” JPA, Elasticsearch, MongoDB ë“±ì—ì„œ ë™ì¼í•œ ë©”ì„œë“œ ë„¤ì´ë° ê·œì¹™ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.
> - `findBy<FieldName>`, `findBy<Field>And<Field>`, `findBy<Field>OrderBy<Field>` ë“±
> - JPAì— ìµìˆ™í•˜ë‹¤ë©´ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
>
> **ì§€ì›ë˜ëŠ” í‚¤ì›Œë“œ ì˜ˆì‹œ:**
> | í‚¤ì›Œë“œ | ì˜ˆì‹œ |
> |--------|------|
> | `And` | `findByTitleAndAuthor` |
> | `Or` | `findByTitleOrContent` |
> | `Between` | `findByCreatedAtBetween` |
> | `LessThan` | `findByPriceLessThan` |
> | `GreaterThan` | `findByPriceGreaterThan` |
> | `Like` | `findByTitleLike` |
> | `OrderBy` | `findByAuthorOrderByCreatedAtDesc` |
> | `Not` | `findByStatusNot` |
> | `In` | `findByStatusIn(Collection)` |

### ì‘ì—… 2: CommentService.findByPostId() ë©”ì„œë“œ êµ¬í˜„
```java
public List<Comment> findByPostId(String postId) {
    return commentRepository.findByPostId(postId);
}
```
- íŠ¹ì • Postì— ë‹¬ë¦° Comment ëª©ë¡ ì¡°íšŒ

### ì‘ì—… 3: BaseInitData work9 ì¶”ê°€
- Postë‹¹ Comment ì¡°íšŒ í…ŒìŠ¤íŠ¸ ë¡œì§


# 25ê°•
## Comment ìˆ˜ì • ê¸°ëŠ¥ êµ¬í˜„ (Update)
- [ì»¤ë°‹ c025](https://github.com/farrar142-examples/p-14646-1/commit/c025)
    - [íŠ¸ë¦¬ c025](https://github.com/farrar142-examples/p-14646-1/tree/c025)

## ì‘ì—…
### ì‘ì—… 1: CommentService.update() ë©”ì„œë“œ êµ¬í˜„
```java
public Comment update(String id, String content) {
    Comment comment = findById(id);
    if (content != null){
        comment.setContent(content);
    }
    return commentRepository.save(comment);
}
```

### ì‘ì—… 2: BaseInitData work10 ì¶”ê°€
- Comment ìˆ˜ì • í…ŒìŠ¤íŠ¸ ë¡œì§


# 26ê°•
## Comment ì‚­ì œ ê¸°ëŠ¥ êµ¬í˜„ (Delete)
- [ì»¤ë°‹ c026](https://github.com/farrar142-examples/p-14646-1/commit/c026)
    - [íŠ¸ë¦¬ c026](https://github.com/farrar142-examples/p-14646-1/tree/c026)

## ì‘ì—…
### ì‘ì—… 1: CommentService.delete() ë©”ì„œë“œ êµ¬í˜„
```java
public void delete(Comment comment) {
    commentRepository.delete(comment);
}
```

> âš ï¸ **JPAì™€ì˜ ì°¨ì´ì  - Cascade ì—†ìŒ**
> - JPA: `@OneToMany(cascade = CascadeType.ALL, orphanRemoval = true)`ë¡œ Post ì‚­ì œ ì‹œ Commentë„ ìë™ ì‚­ì œ
> - Elasticsearch: **Cascadeê°€ ì—†ìœ¼ë¯€ë¡œ ìˆ˜ë™ìœ¼ë¡œ ì²˜ë¦¬ í•„ìš”**
> ```java
> // Post ì‚­ì œ ì‹œ Commentë„ ìˆ˜ë™ìœ¼ë¡œ ì‚­ì œí•´ì•¼ í•¨
> public void deletePost(String postId) {
>     // 1. í•´ë‹¹ Postì˜ ëª¨ë“  Comment ì‚­ì œ
>     commentRepository.deleteByPostId(postId);
>     // 2. Post ì‚­ì œ
>     postRepository.deleteById(postId);
> }
> ```

### ì‘ì—… 2: BaseInitData work11 ì¶”ê°€
- Comment ì‚­ì œ í…ŒìŠ¤íŠ¸ ë¡œì§
- ì‚­ì œ í›„ ë‚¨ì€ Comment ê°œìˆ˜ ë¡œê¹…


---

# 4ë¶€: Post API (Controller Layer)

# 27ê°•
## í…ŒìŠ¤íŠ¸ í™˜ê²½ ì„¤ì • (Testcontainers)
- [ì»¤ë°‹ c027](https://github.com/farrar142-examples/p-14646-1/commit/c027)
    - [íŠ¸ë¦¬ c027](https://github.com/farrar142-examples/p-14646-1/tree/c027)

## ì‘ì—…
### ì‘ì—… 1: Testcontainers ì˜ì¡´ì„± ì¶”ê°€ (`build.gradle.kts`)
```kotlin
testImplementation(platform("org.testcontainers:testcontainers-bom:1.19.8"))
testImplementation("org.testcontainers:junit-jupiter")
testImplementation("org.testcontainers:testcontainers-elasticsearch")
```
- Testcontainers: í…ŒìŠ¤íŠ¸ìš© Docker ì»¨í…Œì´ë„ˆë¥¼ ìë™ìœ¼ë¡œ ê´€ë¦¬
- ì‹¤ì œ Elasticsearch í™˜ê²½ì—ì„œ í†µí•© í…ŒìŠ¤íŠ¸ ê°€ëŠ¥

> ğŸ’¡ **JPA í…ŒìŠ¤íŠ¸ì™€ì˜ ì°¨ì´ì **
> - JPA: `@DataJpaTest`ë¡œ H2 ì¸ë©”ëª¨ë¦¬ DB ì‚¬ìš© ê°€ëŠ¥ (ë¼ì´íŠ¸í•˜ê³  ë¹ ë¦„)
> - Elasticsearch: ì¸ë©”ëª¨ë¦¬ ëª¨ë“œê°€ ì—†ìœ¼ë¯€ë¡œ **ì‹¤ì œ Elasticsearchê°€ í•„ìš”**
> - Testcontainersë¡œ Dockerì—ì„œ Elasticsearchë¥¼ ì‹¤í–‰í•˜ì—¬ í•´ê²°
> - í…ŒìŠ¤íŠ¸ê°€ JPAë³´ë‹¤ ëŠë¦¼ (ì»¨í…Œì´ë„ˆ ì‹œì‘ ì‹œê°„)

### ì‘ì—… 2: BaseTest í´ë˜ìŠ¤ ìƒì„±
```java
public class BaseTest {
    @Container
    public static final ElasticsearchContainer elasticsearchContainer
        = new ElasticsearchContainer(
        DockerImageName.parse("elasticsearch:nori")
    )
        .withEnv("discovery.type", "single-node")
        .withEnv("xpack.security.enabled", "false")
        .withExposedPorts(9200)
        .waitingFor(
                Wait.forHttp("/")
                        .forPort(9200)
                        .forStatusCode(200)
        );

    @DynamicPropertySource
    public static void setElasticsearchProperties(DynamicPropertyRegistry registry) {
        registry.add("spring.elasticsearch.uris", () -> elasticsearchContainer.getHttpHostAddress());
    }
}
```
- `@Container`: Elasticsearch ì»¨í…Œì´ë„ˆ ì •ì˜
- `@DynamicPropertySource`: í…ŒìŠ¤íŠ¸ ì‹œ ë™ì ìœ¼ë¡œ Elasticsearch URI ì£¼ì…
- ëª¨ë“  í…ŒìŠ¤íŠ¸ í´ë˜ìŠ¤ê°€ ìƒì†í•˜ì—¬ Elasticsearch ì»¨í…Œì´ë„ˆ ê³µìœ 

### ì‘ì—… 3: PostControllerTests í´ë˜ìŠ¤ ìƒì„±
- `@SpringBootTest`: ìŠ¤í”„ë§ í†µí•© í…ŒìŠ¤íŠ¸
- `@Testcontainers`: Testcontainers í™œì„±í™”
- `@AutoConfigureMockMvc`: MockMvc ìë™ ì„¤ì •


# 28ê°•
## Post ìƒì„± API êµ¬í˜„ (POST /api/v1/posts)
- [ì»¤ë°‹ c028](https://github.com/farrar142-examples/p-14646-1/commit/c028)
    - [íŠ¸ë¦¬ c028](https://github.com/farrar142-examples/p-14646-1/tree/c028)

## ì‘ì—…
### ì‘ì—… 1: Validation ì˜ì¡´ì„± ì¶”ê°€ (`build.gradle.kts`)
```kotlin
implementation("org.springframework.boot:spring-boot-starter-validation")
```

### ì‘ì—… 2: PostController í´ë˜ìŠ¤ ìƒì„±
```java
@RestController
@RequestMapping("/api/v1/posts")
@RequiredArgsConstructor
public class PostController {

    private final PostService postService;

    record CreatePostRequest(
            @NotBlank(message = "Title must not be blank")
            @Size(max = 100, min = 1)
            String title,
            @NotBlank(message = "Content must not be blank")
            String content,
            @NotBlank(message = "Author must not be blank")
            String author
    ){}

    @PostMapping
    public ResponseEntity<Post> create(
            @RequestBody @Valid CreatePostRequest request
    ){
        Post post = postService.create(
                request.title,
                request.content,
                request.author
        );
        return ResponseEntity.status(201).body(post);
    }
}
```

### ì‘ì—… 3: í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ ì‘ì„±
- ì‹¤íŒ¨ ì¼€ì´ìŠ¤: title ëˆ„ë½ ì‹œ 400 ì‘ë‹µ
- ì„±ê³µ ì¼€ì´ìŠ¤: ìœ íš¨í•œ ìš”ì²­ ì‹œ 201 ì‘ë‹µ ë° ìƒì„±ëœ Post ë°˜í™˜


# 29ê°•
## Post ì „ì²´ ì¡°íšŒ API êµ¬í˜„ (GET /api/v1/posts)
- [ì»¤ë°‹ c029](https://github.com/farrar142-examples/p-14646-1/commit/c029)
    - [íŠ¸ë¦¬ c029](https://github.com/farrar142-examples/p-14646-1/tree/c029)

## ì‘ì—…
### ì‘ì—… 1: PostController.findAll() ë©”ì„œë“œ ì¶”ê°€
```java
@RequestMapping
public List<Post> findAll(){
    return postService.findAll();
}
```

### ì‘ì—… 2: í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ ì‘ì„±
- GET /api/v1/posts ìš”ì²­ ì‹œ 200 ì‘ë‹µ ë° ë¦¬ìŠ¤íŠ¸ ë°˜í™˜ í™•ì¸


# 30ê°•
## ì „ì—­ ì˜ˆì™¸ ì²˜ë¦¬ê¸° êµ¬í˜„ (GlobalExceptionHandler)
- [ì»¤ë°‹ c030](https://github.com/farrar142-examples/p-14646-1/commit/c030)
    - [íŠ¸ë¦¬ c030](https://github.com/farrar142-examples/p-14646-1/tree/c030)

## ì‘ì—…
### ì‘ì—… 1: GlobalExceptionHandler í´ë˜ìŠ¤ ìƒì„±
```java
@RestControllerAdvice
public class GlobalExceptionHandler {
    record ErrorResponse(
            String message,
            String resultCode
    ){}

    @ExceptionHandler(DomainException.class)
    public ResponseEntity<ErrorResponse> handleDomainException(DomainException e){
        ErrorResponse errorResponse = new ErrorResponse(
                e.getMessage(),
                e.resultCode
        );
        return ResponseEntity
                .badRequest()
                .body(errorResponse);
    }

    @ExceptionHandler(NotFoundException.class)
    public ResponseEntity<ErrorResponse> handleNotFoundException(NotFoundException e){
        ErrorResponse errorResponse = new ErrorResponse(
                e.getMessage(),
                e.resultCode
        );
        return ResponseEntity
                .status(404)
                .body(errorResponse);
    }
}
```
- `@RestControllerAdvice`: ëª¨ë“  ì»¨íŠ¸ë¡¤ëŸ¬ì— ì ìš©ë˜ëŠ” ì „ì—­ ì˜ˆì™¸ ì²˜ë¦¬
- ì˜ˆì™¸ íƒ€ì…ì— ë”°ë¼ ì ì ˆí•œ HTTP ìƒíƒœ ì½”ë“œì™€ ì—ëŸ¬ ì‘ë‹µ ë°˜í™˜


# 31ê°•
## Post ë‹¨ê±´ ì¡°íšŒ API êµ¬í˜„ (GET /api/v1/posts/{id})
- [ì»¤ë°‹ c031](https://github.com/farrar142-examples/p-14646-1/commit/c031)
    - [íŠ¸ë¦¬ c031](https://github.com/farrar142-examples/p-14646-1/tree/c031)

## ì‘ì—…
### ì‘ì—… 1: PostController.findById() ë©”ì„œë“œ ì¶”ê°€
```java
@RequestMapping("/{id}")
public Post findById(@PathVariable String id) {
    return postService.findById(id);
}
```

### ì‘ì—… 2: í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ ì‘ì„±
- ì‹¤íŒ¨ ì¼€ì´ìŠ¤: ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ID ì¡°íšŒ ì‹œ 404 ì‘ë‹µ
- ì„±ê³µ ì¼€ì´ìŠ¤: ì¡´ì¬í•˜ëŠ” Post ì¡°íšŒ ì‹œ 200 ì‘ë‹µ ë° Post ë°˜í™˜


# 32ê°•
## Post ìˆ˜ì • API êµ¬í˜„ (PUT /api/v1/posts/{id})
- [ì»¤ë°‹ c032](https://github.com/farrar142-examples/p-14646-1/commit/c032)
    - [íŠ¸ë¦¬ c032](https://github.com/farrar142-examples/p-14646-1/tree/c032)

## ì‘ì—…
### ì‘ì—… 1: PostController.update() ë©”ì„œë“œ ì¶”ê°€
```java
record UpdatePostRequest(
        @NotBlank(message = "Title must not be blank")
        @Size(max = 100, min = 1)
        String title,
        @NotBlank(message = "Content must not be blank")
        String content
){}

@PutMapping("/{id}")
public Post update(
        @PathVariable String id,
        @RequestBody @Valid UpdatePostRequest request
) {
    return postService.update(
            id,
            request.title,
            request.content
    );
}
```

### ì‘ì—… 2: í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ ì‘ì„±
- ì‹¤íŒ¨ ì¼€ì´ìŠ¤: ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ID ìˆ˜ì • ì‹œ 404 ì‘ë‹µ
- ì„±ê³µ ì¼€ì´ìŠ¤: ì¡´ì¬í•˜ëŠ” Post ìˆ˜ì • ì‹œ 200 ì‘ë‹µ ë° ìˆ˜ì •ëœ Post ë°˜í™˜


# 33ê°•
## Post ì‚­ì œ API êµ¬í˜„ (DELETE /api/v1/posts/{id})
- [ì»¤ë°‹ c033](https://github.com/farrar142-examples/p-14646-1/commit/c033)
    - [íŠ¸ë¦¬ c033](https://github.com/farrar142-examples/p-14646-1/tree/c033)

## ì‘ì—…
### ì‘ì—… 1: PostController.delete() ë©”ì„œë“œ ì¶”ê°€
```java
@DeleteMapping("/{id}")
public ResponseEntity<Void> delete(@PathVariable String id) {
    postService.delete(id);
    return ResponseEntity.noContent().build();
}
```
- ì‚­ì œ ì„±ê³µ ì‹œ 204 No Content ì‘ë‹µ

### ì‘ì—… 2: í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ ì‘ì„±
- ì‹¤íŒ¨ ì¼€ì´ìŠ¤: ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ID ì‚­ì œ ì‹œ 404 ì‘ë‹µ
- ì„±ê³µ ì¼€ì´ìŠ¤: ì¡´ì¬í•˜ëŠ” Post ì‚­ì œ ì‹œ 204 ì‘ë‹µ


---

# 5ë¶€: Comment API (Controller Layer)

# 34ê°•
## Comment ìƒì„± API êµ¬í˜„ (POST /api/v1/posts/{postId}/comments)
- [ì»¤ë°‹ c034](https://github.com/farrar142-examples/p-14646-1/commit/c034)
    - [íŠ¸ë¦¬ c034](https://github.com/farrar142-examples/p-14646-1/tree/c034)

## ì‘ì—…
### ì‘ì—… 1: CommentController í´ë˜ìŠ¤ ìƒì„±
```java
@RestController
@RequestMapping("/api/v1/posts/{postId}/comments")
@RequiredArgsConstructor
public class CommentController {

    private final CommentService commentService;
    private final PostService postService;

    public record CreateCommentRequest(
            @NotBlank(message = "Content must not be blank")
            @Size(max = 500, min = 1)
            String content,
            @NotBlank(message = "Author must not be blank")
            @Size(max = 50, min = 1)
            String author
    ) {}

    @PostMapping
    public ResponseEntity<Comment> create(
            @PathVariable String postId,
            @RequestBody @Valid CreateCommentRequest request
    ) {
        Comment comment = commentService.create(
                postService.findById(postId),
                request.content,
                request.author
        );
        return ResponseEntity.status(201).body(comment);
    }
}
```
- RESTful ì¤‘ì²© ë¦¬ì†ŒìŠ¤ URL ì„¤ê³„: `/api/v1/posts/{postId}/comments`
- `@PathVariable`ë¡œ ë¶€ëª¨ ë¦¬ì†ŒìŠ¤(Post) IDë¥¼ ë°›ì•„ ì—°ê´€ ê´€ê³„ ì„¤ì •
- Post ì¡´ì¬ ì—¬ë¶€ë¥¼ ë¨¼ì € í™•ì¸í•˜ì—¬ ìœ íš¨ì„± ê²€ì¦

### ì‘ì—… 2: CommentControllerTests í´ë˜ìŠ¤ ìƒì„±
- ì‹¤íŒ¨ ì¼€ì´ìŠ¤: content ëˆ„ë½ ì‹œ 400 ì‘ë‹µ
- ì‹¤íŒ¨ ì¼€ì´ìŠ¤: ì¡´ì¬í•˜ì§€ ì•ŠëŠ” postId ì‹œ 404 ì‘ë‹µ
- ì„±ê³µ ì¼€ì´ìŠ¤: ìœ íš¨í•œ ìš”ì²­ ì‹œ 201 ì‘ë‹µ ë° ìƒì„±ëœ Comment ë°˜í™˜


# 35ê°•
## Comment Postë³„ ì¡°íšŒ API êµ¬í˜„ (GET /api/v1/posts/{postId}/comments)
- [ì»¤ë°‹ c035](https://github.com/farrar142-examples/p-14646-1/commit/c035)
    - [íŠ¸ë¦¬ c035](https://github.com/farrar142-examples/p-14646-1/tree/c035)

## ì‘ì—…
### ì‘ì—… 1: CommentController.findByPostId() ë©”ì„œë“œ ì¶”ê°€
```java
@GetMapping
public List<Comment> findByPostId(@PathVariable String postId) {
    // Post ì¡´ì¬ ì—¬ë¶€ í™•ì¸
    postService.findById(postId);
    return commentService.findByPostId(postId);
}
```
- Post ì¡´ì¬ ì—¬ë¶€ë¥¼ ë¨¼ì € í™•ì¸ (ì¡´ì¬í•˜ì§€ ì•Šìœ¼ë©´ 404 ì‘ë‹µ)
- í•´ë‹¹ Postì— ë‹¬ë¦° ëª¨ë“  Comment ëª©ë¡ ë°˜í™˜

### ì‘ì—… 2: í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ ì‘ì„±
- ì‹¤íŒ¨ ì¼€ì´ìŠ¤: ì¡´ì¬í•˜ì§€ ì•ŠëŠ” postId ì¡°íšŒ ì‹œ 404 ì‘ë‹µ
- ì„±ê³µ ì¼€ì´ìŠ¤: ì¡´ì¬í•˜ëŠ” Postì˜ Comment ëª©ë¡ ì¡°íšŒ ì‹œ 200 ì‘ë‹µ ë° ë¦¬ìŠ¤íŠ¸ ë°˜í™˜


# 36ê°•
## Comment ë‹¨ê±´ ì¡°íšŒ API êµ¬í˜„ (GET /api/v1/posts/{postId}/comments/{id})
- [ì»¤ë°‹ c036](https://github.com/farrar142-examples/p-14646-1/commit/c036)
    - [íŠ¸ë¦¬ c036](https://github.com/farrar142-examples/p-14646-1/tree/c036)

## ì‘ì—…
### ì‘ì—… 1: CommentController.findById() ë©”ì„œë“œ ì¶”ê°€
```java
@GetMapping("/{id}")
public Comment findById(
        @PathVariable String postId,
        @PathVariable String id
) {
    // Post ì¡´ì¬ ì—¬ë¶€ í™•ì¸
    postService.findById(postId);
    return commentService.findById(id);
}
```
- ë‘ ê°œì˜ `@PathVariable`: postIdì™€ comment id
- Post ì¡´ì¬ ì—¬ë¶€ë¥¼ ë¨¼ì € í™•ì¸í•˜ì—¬ ì¼ê´€ëœ ì—ëŸ¬ ì²˜ë¦¬

### ì‘ì—… 2: í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ ì‘ì„±
- ì‹¤íŒ¨ ì¼€ì´ìŠ¤: ì¡´ì¬í•˜ì§€ ì•ŠëŠ” commentId ì¡°íšŒ ì‹œ 404 ì‘ë‹µ
- ì„±ê³µ ì¼€ì´ìŠ¤: ì¡´ì¬í•˜ëŠ” Comment ì¡°íšŒ ì‹œ 200 ì‘ë‹µ ë° Comment ë°˜í™˜


# 37ê°•
## Comment ìˆ˜ì • API êµ¬í˜„ (PUT /api/v1/posts/{postId}/comments/{id})
- [ì»¤ë°‹ c037](https://github.com/farrar142-examples/p-14646-1/commit/c037)
    - [íŠ¸ë¦¬ c037](https://github.com/farrar142-examples/p-14646-1/tree/c037)

## ì‘ì—…
### ì‘ì—… 1: CommentController.update() ë©”ì„œë“œ ì¶”ê°€
```java
public record UpdateCommentRequest(
        @NotBlank(message = "Content must not be blank")
        @Size(max = 500, min = 1)
        String content
) {}

@PutMapping("/{id}")
public Comment update(
        @PathVariable String postId,
        @PathVariable String id,
        @RequestBody @Valid UpdateCommentRequest request
) {
    // Post ì¡´ì¬ ì—¬ë¶€ í™•ì¸
    postService.findById(postId);
    return commentService.update(id, request.content);
}
```
- CommentëŠ” contentë§Œ ìˆ˜ì • ê°€ëŠ¥ (author, postIdëŠ” ë¶ˆë³€)

### ì‘ì—… 2: í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ ì‘ì„±
- ì‹¤íŒ¨ ì¼€ì´ìŠ¤: ì¡´ì¬í•˜ì§€ ì•ŠëŠ” commentId ìˆ˜ì • ì‹œ 404 ì‘ë‹µ
- ì„±ê³µ ì¼€ì´ìŠ¤: ì¡´ì¬í•˜ëŠ” Comment ìˆ˜ì • ì‹œ 200 ì‘ë‹µ ë° ìˆ˜ì •ëœ Comment ë°˜í™˜


# 38ê°•
## Comment ì‚­ì œ API êµ¬í˜„ (DELETE /api/v1/posts/{postId}/comments/{id})
- [ì»¤ë°‹ c038](https://github.com/farrar142-examples/p-14646-1/commit/c038)
    - [íŠ¸ë¦¬ c038](https://github.com/farrar142-examples/p-14646-1/tree/c038)

## ì‘ì—…
### ì‘ì—… 1: CommentController.delete() ë©”ì„œë“œ ì¶”ê°€
```java
@DeleteMapping("/{id}")
public ResponseEntity<Void> delete(
        @PathVariable String postId,
        @PathVariable String id
) {
    // Post ì¡´ì¬ ì—¬ë¶€ í™•ì¸
    postService.findById(postId);
    Comment comment = commentService.findById(id);
    commentService.delete(comment);
    return ResponseEntity.noContent().build();
}
```
- ì‚­ì œ ì„±ê³µ ì‹œ 204 No Content ì‘ë‹µ
- Comment ê°ì²´ë¥¼ ë¨¼ì € ì¡°íšŒí•œ í›„ ì‚­ì œ (ì¡´ì¬í•˜ì§€ ì•Šìœ¼ë©´ 404 ì‘ë‹µ)

### ì‘ì—… 2: í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ ì‘ì„±
- ì‹¤íŒ¨ ì¼€ì´ìŠ¤: ì¡´ì¬í•˜ì§€ ì•ŠëŠ” commentId ì‚­ì œ ì‹œ 404 ì‘ë‹µ
- ì„±ê³µ ì¼€ì´ìŠ¤: ì¡´ì¬í•˜ëŠ” Comment ì‚­ì œ ì‹œ 204 ì‘ë‹µ
- ì‚­ì œ í›„ ì¬ì¡°íšŒ ì‹œ 404 ì‘ë‹µ í™•ì¸


---

# 6ë¶€: Pagination êµ¬í˜„

# 39ê°•
## Post ëª©ë¡ Pagination êµ¬í˜„
- [ì»¤ë°‹ c039](https://github.com/farrar142-examples/p-14646-1/commit/c039)
    - [íŠ¸ë¦¬ c039](https://github.com/farrar142-examples/p-14646-1/tree/c039)

## ì‘ì—…
### ì‘ì—… 1: PostRepositoryì— Pagination ë©”ì„œë“œ ì¶”ê°€
```java
public interface PostRepository extends ElasticsearchRepository<Post, String> {
    List<Post> findAll();
    Page<Post> findAll(Pageable pageable);
}
```

### ì‘ì—… 2: PostServiceì— Pagination findAll ë©”ì„œë“œ ì¶”ê°€
```java
public Page<Post> findAll(Pageable pageable) {
    return postRepository.findAll(pageable);
}
```

### ì‘ì—… 3: PostController.findAll() ë©”ì„œë“œ ìˆ˜ì •
```java
@RequestMapping
public Page<Post> findAll(
        @RequestParam(defaultValue = "0") int page,
        @RequestParam(defaultValue = "10") int size
) {
    Pageable pageable = PageRequest.of(page, size);
    return postService.findAll(pageable);
}
```
- `@RequestParam`ìœ¼ë¡œ page, size íŒŒë¼ë¯¸í„° ìˆ˜ì‹ 
- ê¸°ë³¸ê°’: page=0, size=10
- `Page<Post>` ë°˜í™˜ìœ¼ë¡œ í˜ì´ì§• ë©”íƒ€ë°ì´í„° í¬í•¨

> ğŸ’¡ **JPAì™€ ë™ì¼í•œ Pagination ë°©ì‹**
> - Spring DataëŠ” JPA, Elasticsearch, MongoDB ë“±ì—ì„œ ë™ì¼í•œ `Pageable`/`Page` ì¸í„°í˜ì´ìŠ¤ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
> - `PageRequest.of(page, size)` ë˜ëŠ” `PageRequest.of(page, size, Sort.by(...))`
> - ë°˜í™˜ë˜ëŠ” `Page<T>`ì—ëŠ” content, totalElements, totalPages, number, size ë“± ë©”íƒ€ë°ì´í„° í¬í•¨

### ì‘ì—… 4: í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ ì‘ì„±
- Pagination íŒŒë¼ë¯¸í„° í…ŒìŠ¤íŠ¸ (page, size ì§€ì •)
- ê¸°ë³¸ Pagination í…ŒìŠ¤íŠ¸ (page=0, size=10 ê¸°ë³¸ê°’)


# 40ê°•
## Comment ëª©ë¡ Pagination êµ¬í˜„
- [ì»¤ë°‹ c040](https://github.com/farrar142-examples/p-14646-1/commit/c040)
    - [íŠ¸ë¦¬ c040](https://github.com/farrar142-examples/p-14646-1/tree/c040)

## ì‘ì—…
### ì‘ì—… 1: CommentRepositoryì— Pagination ë©”ì„œë“œ ì¶”ê°€
```java
public interface CommentRepository extends ElasticsearchRepository<Comment, String> {
    List<Comment> findAll();
    List<Comment> findByPostId(String postId);
    Page<Comment> findByPostId(String postId, Pageable pageable);
}
```

### ì‘ì—… 2: CommentServiceì— Pagination findByPostId ë©”ì„œë“œ ì¶”ê°€
```java
public Page<Comment> findByPostId(String postId, Pageable pageable) {
    return commentRepository.findByPostId(postId, pageable);
}
```

### ì‘ì—… 3: CommentController.findByPostId() ë©”ì„œë“œ ìˆ˜ì •
```java
@GetMapping
public Page<Comment> findByPostId(
        @PathVariable String postId,
        @RequestParam(defaultValue = "0") int page,
        @RequestParam(defaultValue = "10") int size
) {
    // Post ì¡´ì¬ ì—¬ë¶€ í™•ì¸
    postService.findById(postId);
    Pageable pageable = PageRequest.of(page, size);
    return commentService.findByPostId(postId, pageable);
}
```
- Postë³„ Comment ì¡°íšŒì— Pagination ì ìš©
- `@RequestParam`ìœ¼ë¡œ page, size íŒŒë¼ë¯¸í„° ìˆ˜ì‹ 
- ê¸°ë³¸ê°’: page=0, size=10

### ì‘ì—… 4: í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ ì‘ì„±
- Pagination íŒŒë¼ë¯¸í„° í…ŒìŠ¤íŠ¸ (page, size ì§€ì •)
- ê¸°ì¡´ í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ Page ì‘ë‹µ í˜•ì‹ìœ¼ë¡œ ìˆ˜ì •


---

# 7ë¶€: ê²€ìƒ‰ ê¸°ëŠ¥ êµ¬í˜„

# 41ê°•
## Post ê²€ìƒ‰ API êµ¬í˜„
- [ì»¤ë°‹ c041](https://github.com/farrar142-examples/p-14646-1/commit/c041)
    - [íŠ¸ë¦¬ c041](https://github.com/farrar142-examples/p-14646-1/tree/c041)

## ì‘ì—…
### ì‘ì—… 1: PostRepositoryì— ê²€ìƒ‰ ë©”ì„œë“œ ì¶”ê°€
```java
public interface PostRepository extends ElasticsearchRepository<Post, String> {
    // ... ê¸°ì¡´ ë©”ì„œë“œ
    
    // ì œëª© ê²€ìƒ‰
    Page<Post> findByTitleContaining(String keyword, Pageable pageable);
    
    // ë‚´ìš© ê²€ìƒ‰
    Page<Post> findByContentContaining(String keyword, Pageable pageable);
    
    // ì œëª© + ë‚´ìš© ê²€ìƒ‰
    Page<Post> findByTitleContainingOrContentContaining(String titleKeyword, String contentKeyword, Pageable pageable);
}
```

> ğŸ’¡ **ElasticsearchRepository ì¿¼ë¦¬ ë©”ì„œë“œ ëª…ëª… ê·œì¹™**
> - `findBy<Field>Containing`: í•´ë‹¹ í•„ë“œì—ì„œ í‚¤ì›Œë“œë¥¼ í¬í•¨í•˜ëŠ” ë¬¸ì„œ ê²€ìƒ‰
> - `Or`ë¡œ ì—¬ëŸ¬ ì¡°ê±´ ì—°ê²° ê°€ëŠ¥
> - JPAì˜ ì¿¼ë¦¬ ë©”ì„œë“œ ëª…ëª… ê·œì¹™ê³¼ ìœ ì‚¬

### ì‘ì—… 2: PostServiceì— SearchType ì—´ê±°í˜• ë° search ë©”ì„œë“œ ì¶”ê°€
```java
public enum SearchType {
    TITLE,
    CONTENT,
    TITLE_CONTENT
}

public Page<Post> search(String keyword, SearchType searchType, Pageable pageable) {
    return switch (searchType) {
        case TITLE -> postRepository.findByTitleContaining(keyword, pageable);
        case CONTENT -> postRepository.findByContentContaining(keyword, pageable);
        case TITLE_CONTENT -> postRepository.findByTitleContainingOrContentContaining(keyword, keyword, pageable);
    };
}
```
- `SearchType` ì—´ê±°í˜•ìœ¼ë¡œ ê²€ìƒ‰ íƒ€ì… êµ¬ë¶„
- switch expressionì„ ì‚¬ìš©í•œ ê°„ê²°í•œ ë¶„ê¸° ì²˜ë¦¬

### ì‘ì—… 3: PostController.findAll() ë©”ì„œë“œì— ê²€ìƒ‰ íŒŒë¼ë¯¸í„° ì¶”ê°€
```java
@RequestMapping
public Page<Post> findAll(
        @RequestParam(defaultValue = "0") int page,
        @RequestParam(defaultValue = "10") int size,
        @RequestParam(required = false) String keyword,
        @RequestParam(required = false) PostService.SearchType searchType
) {
    Pageable pageable = PageRequest.of(page, size);
    
    if (keyword != null && !keyword.isBlank() && searchType != null) {
        return postService.search(keyword, searchType, pageable);
    }
    
    return postService.findAll(pageable);
}
```
- `keyword`: ê²€ìƒ‰ í‚¤ì›Œë“œ (ì„ íƒ)
- `searchType`: ê²€ìƒ‰ ìœ í˜• - TITLE, CONTENT, TITLE_CONTENT (ì„ íƒ)
- ê²€ìƒ‰ ì¡°ê±´ì´ ìˆìœ¼ë©´ ê²€ìƒ‰, ì—†ìœ¼ë©´ ì „ì²´ ëª©ë¡ ë°˜í™˜

### ì‘ì—… 4: í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ ì‘ì„±
- ì œëª© ê²€ìƒ‰ í…ŒìŠ¤íŠ¸ (`searchType=TITLE`)
- ë‚´ìš© ê²€ìƒ‰ í…ŒìŠ¤íŠ¸ (`searchType=CONTENT`)
- ì œëª©+ë‚´ìš© ê²€ìƒ‰ í…ŒìŠ¤íŠ¸ (`searchType=TITLE_CONTENT`)


# 42ê°•
## Comment ê²€ìƒ‰ API êµ¬í˜„
- [ì»¤ë°‹ c042](https://github.com/farrar142-examples/p-14646-1/commit/c042)
    - [íŠ¸ë¦¬ c042](https://github.com/farrar142-examples/p-14646-1/tree/c042)

## ì‘ì—…
### ì‘ì—… 1: CommentRepositoryì— ê²€ìƒ‰ ë©”ì„œë“œ ì¶”ê°€
```java
public interface CommentRepository extends ElasticsearchRepository<Comment, String> {
    // ... ê¸°ì¡´ ë©”ì„œë“œ
    
    // ë‚´ìš© ê²€ìƒ‰
    Page<Comment> findByPostIdAndContentContaining(String postId, String keyword, Pageable pageable);
    
    // ì‘ì„±ì ê²€ìƒ‰
    Page<Comment> findByPostIdAndAuthorContaining(String postId, String keyword, Pageable pageable);
    
    // ë‚´ìš© + ì‘ì„±ì ê²€ìƒ‰
    Page<Comment> findByPostIdAndContentContainingOrPostIdAndAuthorContaining(
            String postId1, String contentKeyword, 
            String postId2, String authorKeyword, 
            Pageable pageable
    );
}
```

> ğŸ’¡ **ë³µí•© ì¡°ê±´ ì¿¼ë¦¬ ë©”ì„œë“œ**
> - `And`ë¡œ í•„ìˆ˜ ì¡°ê±´(postId)ê³¼ ê²€ìƒ‰ ì¡°ê±´ ì—°ê²°
> - `Or`ë¡œ ë‹¤ì¤‘ ê²€ìƒ‰ ì¡°ê±´ ì—°ê²° ì‹œ, ê° ì¡°ê±´ì— í•„ìˆ˜ ì¡°ê±´ ë°˜ë³µ í•„ìš”
> - ì˜ˆ: `PostIdAndContentContainingOrPostIdAndAuthorContaining`

### ì‘ì—… 2: CommentServiceì— SearchType ì—´ê±°í˜• ë° search ë©”ì„œë“œ ì¶”ê°€
```java
public enum SearchType {
    CONTENT,
    AUTHOR,
    CONTENT_AUTHOR
}

public Page<Comment> search(String postId, String keyword, SearchType searchType, Pageable pageable) {
    return switch (searchType) {
        case CONTENT -> commentRepository.findByPostIdAndContentContaining(postId, keyword, pageable);
        case AUTHOR -> commentRepository.findByPostIdAndAuthorContaining(postId, keyword, pageable);
        case CONTENT_AUTHOR -> commentRepository.findByPostIdAndContentContainingOrPostIdAndAuthorContaining(
                postId, keyword, postId, keyword, pageable);
    };
}
```
- Comment ê²€ìƒ‰ì€ í•­ìƒ íŠ¹ì • Post ë²”ìœ„ ë‚´ì—ì„œ ìˆ˜í–‰
- `SearchType`: CONTENT, AUTHOR, CONTENT_AUTHOR

### ì‘ì—… 3: CommentController.findByPostId() ë©”ì„œë“œì— ê²€ìƒ‰ íŒŒë¼ë¯¸í„° ì¶”ê°€
```java
@GetMapping
public Page<Comment> findByPostId(
        @PathVariable String postId,
        @RequestParam(defaultValue = "0") int page,
        @RequestParam(defaultValue = "10") int size,
        @RequestParam(required = false) String keyword,
        @RequestParam(required = false) CommentService.SearchType searchType
) {
    // Post ì¡´ì¬ ì—¬ë¶€ í™•ì¸
    postService.findById(postId);
    
    Pageable pageable = PageRequest.of(page, size);
    
    if (keyword != null && !keyword.isBlank() && searchType != null) {
        return commentService.search(postId, keyword, searchType, pageable);
    }
    
    return commentService.findByPostId(postId, pageable);
}
```
- `keyword`: ê²€ìƒ‰ í‚¤ì›Œë“œ (ì„ íƒ)
- `searchType`: ê²€ìƒ‰ ìœ í˜• - CONTENT, AUTHOR, CONTENT_AUTHOR (ì„ íƒ)

### ì‘ì—… 4: í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ ì‘ì„±
- ë‚´ìš© ê²€ìƒ‰ í…ŒìŠ¤íŠ¸ (`searchType=CONTENT`)
- ì‘ì„±ì ê²€ìƒ‰ í…ŒìŠ¤íŠ¸ (`searchType=AUTHOR`)
- ë‚´ìš©+ì‘ì„±ì ê²€ìƒ‰ í…ŒìŠ¤íŠ¸ (`searchType=CONTENT_AUTHOR`)


---

# ë¶€ë¡: JPA ê°œë°œìë¥¼ ìœ„í•œ Elasticsearch íŒ

## ğŸ”„ JPAì—ì„œ Elasticsearchë¡œ ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹œ ì£¼ì˜ì‚¬í•­

### 1. íŠ¸ëœì­ì…˜ ì²˜ë¦¬
```java
// JPA - ì—¬ëŸ¬ ì—”í‹°í‹°ë¥¼ í•˜ë‚˜ì˜ íŠ¸ëœì­ì…˜ìœ¼ë¡œ ì²˜ë¦¬
@Transactional
public void transferMoney(Long fromId, Long toId, BigDecimal amount) {
    Account from = accountRepository.findById(fromId).get();
    Account to = accountRepository.findById(toId).get();
    from.withdraw(amount);
    to.deposit(amount);
    // ë‘˜ ë‹¤ ì„±ê³µí•˜ê±°ë‚˜ ë‘˜ ë‹¤ ì‹¤íŒ¨
}

// Elasticsearch - íŠ¸ëœì­ì…˜ ì—†ìŒ, ê°ê° ë…ë¦½ì 
public void transferMoney(String fromId, String toId, BigDecimal amount) {
    Account from = accountRepository.findById(fromId).get();
    from.withdraw(amount);
    accountRepository.save(from);  // ì´ê²Œ ì„±ê³µí•˜ê³ 
    
    Account to = accountRepository.findById(toId).get();
    to.deposit(amount);
    accountRepository.save(to);  // ì´ê²Œ ì‹¤íŒ¨í•˜ë©´ ë¶ˆì¼ì¹˜ ë°œìƒ!
}
```
> âš ï¸ ElasticsearchëŠ” íŠ¸ëœì­ì…˜ì´ ì—†ìœ¼ë¯€ë¡œ, ì›ìì  ì²˜ë¦¬ê°€ í•„ìš”í•œ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì—ëŠ” ì í•©í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.

### 2. N+1 ë¬¸ì œ ì²˜ë¦¬ ë°©ì‹
```java
// JPA - Fetch Joinìœ¼ë¡œ í•´ê²°
@Query("SELECT p FROM Post p JOIN FETCH p.comments WHERE p.id = :id")
Optional<Post> findByIdWithComments(Long id);

// Elasticsearch - ë¹„ì •ê·œí™” ë˜ëŠ” ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ ì¡°í•©
public PostWithComments findByIdWithComments(String id) {
    Post post = postRepository.findById(id).get();
    List<Comment> comments = commentRepository.findByPostId(id);
    return new PostWithComments(post, comments);
}
```

### 3. ê²€ìƒ‰ ê¸°ëŠ¥ í™œìš©
```java
// JPA - LIKE ê²€ìƒ‰ (ë¹„íš¨ìœ¨ì )
@Query("SELECT p FROM Post p WHERE p.title LIKE %:keyword%")
List<Post> searchByTitle(String keyword);

// Elasticsearch - ì „ë¬¸ ê²€ìƒ‰ (ë§¤ìš° íš¨ìœ¨ì , ê°•ì !)
List<Post> findByTitleContaining(String keyword);  // í˜•íƒœì†Œ ë¶„ì„ ì ìš©
```
> ğŸ’¡ ElasticsearchëŠ” ì „ë¬¸ ê²€ìƒ‰ì— ìµœì í™”ë˜ì–´ ìˆìŠµë‹ˆë‹¤. ê²€ìƒ‰ì´ í•µì‹¬ì¸ ì„œë¹„ìŠ¤ì— ì í•©í•©ë‹ˆë‹¤.

### 4. Near Real-time íŠ¹ì„±
```java
// ElasticsearchëŠ” ì €ì¥ í›„ ì¦‰ì‹œ ê²€ìƒ‰ë˜ì§€ ì•Šì„ ìˆ˜ ìˆìŒ (ê¸°ë³¸ 1ì´ˆ refresh)
postRepository.save(post);
// ë°”ë¡œ ì•„ë˜ì—ì„œ ê²€ìƒ‰í•˜ë©´ ì•ˆ ë‚˜ì˜¬ ìˆ˜ ìˆìŒ!
List<Post> posts = postRepository.findByTitle("ìƒˆ ê¸€");

// ê°•ì œ refreshê°€ í•„ìš”í•œ ê²½ìš° (ì„±ëŠ¥ ì €í•˜ ì£¼ì˜)
elasticsearchOperations.indexOps(Post.class).refresh();
```


## âœ… Elasticsearchê°€ ì í•©í•œ ê²½ìš°
- ì „ë¬¸ ê²€ìƒ‰ì´ í•µì‹¬ì¸ ì„œë¹„ìŠ¤ (ê²€ìƒ‰ ì—”ì§„, ë¡œê·¸ ë¶„ì„)
- ì½ê¸°ê°€ ë§ê³  ì“°ê¸°ê°€ ì ì€ ì„œë¹„ìŠ¤
- ë³µì¡í•œ ê´€ê³„ê°€ í•„ìš” ì—†ëŠ” ë¬¸ì„œ ê¸°ë°˜ ë°ì´í„°
- ëŒ€ìš©ëŸ‰ ë°ì´í„°ì˜ ë¹ ë¥¸ ê²€ìƒ‰ì´ í•„ìš”í•œ ê²½ìš°

## âŒ Elasticsearchê°€ ë¶€ì í•©í•œ ê²½ìš°
- ë³µì¡í•œ ê´€ê³„í˜• ë°ì´í„° ëª¨ë¸ë§ì´ í•„ìš”í•œ ê²½ìš°
- íŠ¸ëœì­ì…˜ ì²˜ë¦¬ê°€ ì¤‘ìš”í•œ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§
- ì‹¤ì‹œê°„ ë°ì´í„° ì¼ê´€ì„±ì´ ì¤‘ìš”í•œ ê²½ìš°
- ë‹¨ìˆœ CRUD ìœ„ì£¼ì˜ ì„œë¹„ìŠ¤

